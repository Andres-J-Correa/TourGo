name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.2.2
        env:
          SQL_CONN_STRING: ${{ secrets.SERVER_MY_SQL_DATABASE_CONN_STRING_PROD }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          envs: SQL_CONN_STRING
          script: |
            # --- CHANGE TO REPO DIRECTORY ---
            cd ~/TourGo || { echo "Directory ~/TourGo does not exist"; exit 1; }

            # --- SYNC LATEST CODE ---
            git checkout main || { echo "git checkout main failed"; exit 1; }
            git fetch origin main || { echo "Failed to fetch origin/main"; exit 1; }
            git reset --hard origin/main || { echo "Failed to reset to origin/main"; exit 1; }

            # --- CLIENT DEPLOYMENT ---
            cd client

            echo "Building client image..."
            if docker compose --profile prod build; then
                echo "Build successful. Deploying..."
                docker compose --profile prod up -d
            else
                echo "Client build failed. Aborting deployment to keep existing service running."
                exit 1
            fi

            # --- LEGAL PAGES DEPLOYMENT ---
            cd ..
            if [ -d "./legal" ] && [ "$(ls -A ./legal)" ]; then
                echo "Deploying legal pages..."
                sudo mkdir -p /var/www/html/legal
                sudo rsync -avz --delete ./legal/ /var/www/html/legal/
            else
                echo "Legal folder is missing or empty â€” skipping."
            fi

            # --- SERVER DEPLOYMENT ---
            cd server
            # Create .env file with secrets
            echo "Creating .env file with secrets..."
            printf "SQL_CONN='%s'\n" "$SQL_CONN_STRING" > .env
            printf "JWT_SECRET=${{ secrets.SERVER_JSON_WEB_TOKEN_SECRET }}\n" >> .env
            printf "BREVO_KEY=${{ secrets.SERVER_BREVO_API_KEY }}\n" >> .env
            printf "S3_ACCESS=${{ secrets.SERVER_AWS_S3_ACCESS_KEY }}\n" >> .env
            printf "S3_SECRET=${{ secrets.SERVER_AWS_S3_SECRET_KEY }}\n" >> .env
            printf "PII_KEY=${{ secrets.SERVER_USER_PII_ENCRYPTION_KEY }}\n" >> .env
            printf "RECAPTCHA_KEY=${{ secrets.SERVER_GOOGLE_RECAPTCHA_SECRET_KEY }}\n" >> .env
            printf "GRAFANA_OTLP_AUTH=${{ secrets.SERVER_GRAFANA_OTLP_AUTH }}\n" >> .env

            # --- DOCKER PROD ---
            echo "Building server image..."
            if docker compose --profile prod build; then
                echo "Build successful. Deploying..."
                docker compose --profile prod up -d
            else
                echo "Server build failed. Aborting deployment to keep existing service running."
                exit 1
            fi

            # --- CLEANUP ---
            docker image prune -f
