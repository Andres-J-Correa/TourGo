name: Deploy to VPS (Stage)

on:
  push:
    branches:
      - stage

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.2.2
        env:
          SQL_PASS: ${{ secrets.SERVER_MY_SQL_DATABASE_PASSWORD_STAGE }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          envs: SQL_PASS
          script: |
            # --- CHANGE TO REPO DIRECTORY ---
            cd ~/TourGo-Stage || { echo "Directory ~/TourGo-Stage does not exist"; exit 1; }

            # --- SYNC LATEST CODE ---
            git checkout stage || { echo "git checkout stage failed"; exit 1; }
            git fetch origin stage || { echo "Failed to fetch origin/stage"; exit 1; }
            git reset --hard origin/stage || { echo "Failed to reset to origin/stage"; exit 1; }

            # --- CLIENT DEPLOYMENT ---
            cd client

            echo "Building client image..."
            if docker compose --profile stage build; then
                echo "Build successful. Deploying..."
                docker compose --profile stage up -d
            else
                echo "Client build failed. Aborting deployment to keep existing service running."
                exit 1
            fi

            # --- LEGAL PAGES DEPLOYMENT ---
            cd ..
            if [ -d "./legal" ] && [ "$(ls -A ./legal)" ]; then
                echo "Deploying legal pages..."
                sudo mkdir -p /var/www/html-stage/legal
                sudo rsync -avz --delete ./legal/ /var/www/html-stage/legal/
            else
                echo "Legal folder is missing or empty â€” skipping."
            fi

            # --- SERVER DEPLOYMENT ---
            cd server
            # Create .env file with secrets
            echo "Creating .env file with secrets..."
            printf "SQL_CONN='%s'\n" "$SQL_PASS" > .env
            printf "JWT_SECRET=${{ secrets.SERVER_JSON_WEB_TOKEN_SECRET }}\n" >> .env
            printf "BREVO_KEY=${{ secrets.SERVER_BREVO_API_KEY }}\n" >> .env
            printf "S3_ACCESS=${{ secrets.SERVER_AWS_S3_ACCESS_KEY }}\n" >> .env
            printf "S3_SECRET=${{ secrets.SERVER_AWS_S3_SECRET_KEY }}\n" >> .env
            printf "PII_KEY=${{ secrets.SERVER_USER_PII_ENCRYPTION_KEY }}\n" >> .env
            printf "RECAPTCHA_KEY=${{ secrets.SERVER_GOOGLE_RECAPTCHA_SECRET_KEY }}\n" >> .env

            # --- DOCKER STAGE ---
            echo "Building server image..."
            if docker compose --profile stage build; then
                echo "Build successful. Deploying..."
                docker compose --profile stage up -d
            else
                echo "Server build failed. Aborting deployment to keep existing service running."
                exit 1
            fi

            # --- CLEANUP ---
            docker image prune -f
