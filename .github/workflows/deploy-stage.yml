name: Deploy to VPS (Stage)

on:
  push:
    branches:
      - stage

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            # --- CHANGE TO REPO DIRECTORY ---
            cd ~/TourGo-Stage || { echo "Directory ~/TourGo-Stage does not exist"; exit 1; }

            # --- SYNC LATEST CODE ---
            git checkout stage || { echo "git checkout stage failed"; exit 1; }
            git fetch origin stage || { echo "Failed to fetch origin/stage"; exit 1; }
            git reset --hard origin/stage || { echo "Failed to reset to origin/stage"; exit 1; }

            # --- CLIENT DEPLOYMENT ---
            cd client

            echo "Building client image..."
            if docker compose --profile stage build; then
                echo "Build successful. Deploying..."
                docker compose --profile stage up -d
            else
                echo "Client build failed. Aborting deployment to keep existing service running."
                exit 1
            fi

            # --- LEGAL PAGES DEPLOYMENT ---
            cd ..
            if [ -d "./legal" ] && [ "$(ls -A ./legal)" ]; then
                echo "Deploying legal pages..."
                sudo mkdir -p /var/www/html-stage/legal
                sudo rsync -avz --delete ./legal/ /var/www/html-stage/legal/
            else
                echo "Legal folder is missing or empty â€” skipping."
            fi

            # --- SERVER DEPLOYMENT ---
            dotnet publish server/TourGo.Web.Api/TourGo.Web.Api.csproj -c Release -o ./server/publish || { echo "dotnet publish failed"; exit 1; }

            if [ -d "./server/publish" ] && [ "$(ls -A ./server/publish)" ]; then
                sudo rsync -avz --delete ./server/publish/ /var/www/server-stage/
            else
                echo "Publish directory is missing or empty"
                exit 1
            fi

            # --- INJECT SECRETS INTO appsettings.Staging.json ---
            cd /var/www/server-stage
            jq --arg json_token_secret "${{ secrets.SERVER_JSON_WEB_TOKEN_SECRET }}" \
               --arg mysql_conn_string "${{ secrets.SERVER_MY_SQL_DATABASE_CONN_STRING_STAGE }}" \
               --arg brevo_api_key "${{ secrets.SERVER_BREVO_API_KEY }}" \
               --arg awss3_access_key "${{ secrets.SERVER_AWS_S3_ACCESS_KEY }}" \
               --arg awss3_secret_key "${{ secrets.SERVER_AWS_S3_SECRET_KEY }}" \
               --arg user_pii_encrypt_key "${{ secrets.SERVER_USER_PII_ENCRYPTION_KEY }}" \
               --arg google_recaptcha_v3_secret_key "${{ secrets.SERVER_GOOGLE_RECAPTCHA_SECRET_KEY }}" \
               '.JsonWebTokenConfig.Secret = $json_token_secret |
                .ConnectionStrings.MySql = $mysql_conn_string |
                .BrevoConfig.ApiKey = $brevo_api_key |
                .AWSS3Config.AccessKey = $awss3_access_key |
                .AWSS3Config.SecretKey = $awss3_secret_key |
                .EncryptionConfig.UserPIIKey = $user_pii_encrypt_key |
                .GoogleRecaptchaConfig.SecretKey = $google_recaptcha_v3_secret_key' \
               appsettings.Staging.json > appsettings.Staging.tmp && mv appsettings.Staging.tmp appsettings.Staging.json

            # --- RESTART SERVER ---
            sudo systemctl restart kestrel-tourgo-stage
