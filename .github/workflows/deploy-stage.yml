name: Deploy to VPS

on:
  push:
    branches:
      - stage

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            # Change to repo directory
            cd ~/TourGo-Stage || { echo "Directory ~/TourGo-Stage does not exist"; exit 1; }

            # Pull latest changes
            git checkout stage || { echo "git checkout stage failed"; exit 1; }
            git fetch origin stage || { echo "Failed to fetch origin/stage"; exit 1; }
            git reset --hard origin/stage || { echo "Failed to reset to origin/stage"; exit 1; }

            # Inject secrets into .env.staging
            cd client

            # Client Deployment
            yarn install || { echo "yarn install failed"; exit 1; }
            yarn build:stage || { echo "yarn build:stage failed"; exit 1; }
            if [ -d "./build" ] && [ "$(ls -A ./build)" ]; then
                # Create the /app subfolder if it doesn't exist
                sudo mkdir -p /var/www/html-stage/app
                # Sync build output to /app
                sudo rsync -avz --delete ./build/ /var/www/html-stage/app/
            else
                echo "Build directory is missing or empty"
                exit 1
            fi

            # Server Deployment
            cd ..
            dotnet publish server/TourGo.Web.Api/TourGo.Web.Api.csproj -c Release -o ./server/publish || { echo "dotnet publish failed"; exit 1; }
            if [ -d "./server/publish" ] && [ "$(ls -A ./server/publish)" ]; then
                sudo rsync -avz --delete ./server/publish/ /var/www/server-stage/
            else
                echo "Publish directory is missing or empty"
                exit 1
            fi


            # Inject secrets into appsettings.Staging.json
            cd ~
            cd /var/www/server-stage
            jq --arg json_token_secret "${{ secrets.SERVER_JSON_WEB_TOKEN_SECRET }}" \
               --arg mysql_conn_string "${{ secrets.SERVER_MY_SQL_DATABASE_CONN_STRING_STAGE }}" \
               --arg brevo_api_key "${{ secrets.SERVER_BREVO_API_KEY }}" \
               --arg awss3_access_key "${{ secrets.SERVER_AWS_S3_ACCESS_KEY }}" \
               --arg awss3_secret_key "${{ secrets.SERVER_AWS_S3_SECRET_KEY }}" \
               --arg user_pii_encrypt_key "${{ secrets.SERVER_USER_PII_ENCRYPTION_KEY }}" \
               --arg google_recaptcha_v3_secret_key "${{ secrets.SERVER_GOOGLE_RECAPTCHA_SECRET_KEY }}" \
               '.JsonWebTokenConfig.Secret = $json_token_secret |
                .ConnectionStrings.MySql = $mysql_conn_string |
                .BrevoConfig.ApiKey = $brevo_api_key |
                .AWSS3Config.AccessKey = $awss3_access_key |
                .AWSS3Config.SecretKey = $awss3_secret_key |
                .EncryptionConfig.UserPIIKey = $user_pii_encrypt_key |
                .GoogleRecaptchaConfig.SecretKey = $google_recaptcha_v3_secret_key' \
               appsettings.Staging.json > appsettings.Staging.tmp && mv appsettings.Staging.tmp appsettings.Staging.json

            sudo systemctl restart kestrel-tourgo-stage
