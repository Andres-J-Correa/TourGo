server {
    listen 80;
    
    # HOST AND PORT HANDLING
    # Disable absolute redirects so Nginx sends "Location: /app/" instead of "http://localhost:80/app/"
    # This prevents the browser from being redirected to port 80 (Connection Refused) when accessing via port 3000.
    absolute_redirect off;
    port_in_redirect off;

    # Root is one level above 'app' because the build is copied to /usr/share/nginx/html/app
    root /usr/share/nginx/html;

    # --- Proxy Settings ---
    # Access the backend running on the host machine.
    # Note: host.docker.internal resolves to the host IP on Docker Desktop (Windows/Mac).
    
    location /hubs/ {
        proxy_pass http://host.docker.internal:50001;
        
        # WebSocket Support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;

        proxy_buffering off;
        proxy_read_timeout 100s;
    }

    location /api/ {
        # limit_req zone=mylimit burst=20 nodelay; 
        proxy_pass http://host.docker.internal:50001;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "keep-alive";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # --- Static Assets & Caching ---

    # Landing Page Assets
    # Maps /landing-assets/ -> /usr/share/nginx/html/app/landing-assets/
    location /landing-assets/ {
        alias /usr/share/nginx/html/app/landing-assets/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    # React App Assets (Vite uses /assets/)
    # Matches /app/assets/...
    location ~ ^/app/assets/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }
    
    # Legacy/Reference support if any files are in static (optional)
    location ~ ^/app/static/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Prevent caching for index.html and service worker
    location ~ ^/app/(index\.html|service-worker\.js)$ {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        try_files $uri =404;
    }

    # --- Application Routes ---

    # React App (SPA Support)
    # Serves /app/index.html for any request starting with /app
    location ~ ^/app(/.*)?$ {
        index index.html;
        try_files $uri $uri/ /app/index.html;
    }

    # Landing Page (Root)
    # Serves landing.html for root requests
    location / {
        # try_files $uri looks for file relative to root (/usr/share/nginx/html)
        # fallback is /app/landing.html -> /usr/share/nginx/html/app/landing.html
        try_files $uri /app/landing.html =404;
        add_header Cache-Control "no-cache";
    }
}